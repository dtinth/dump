(window.webpackJsonp_N_E=window.webpackJsonp_N_E||[]).push([[16],{SoOo:function(e,n,t){"use strict";t.r(n);var o=t("Texg");function i(){}function r(e,n){return e===i?n:function(){var t=e.apply(this,arguments);if(t&&"function"===typeof t.then){var o=this,i=arguments;return t.then((function(){return n.apply(o,i)}))}return n.apply(this,arguments)}}function a(){var e=Date.now();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(n){var t=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===n?t:7&t|8).toString(16)}))}var s=1,c=2,u=3;function l(e){return function(n){if(!n.hook._observing){n.hook._observing=!0;var t=n.name;n.hook("creating").subscribe(function(e,n){return function(t,i,r){var c=void 0;void 0===t&&n.schema.primKey.uuid&&(t=c=a(),n.schema.primKey.keyPath&&o.a.setByKeyPath(i,n.schema.primKey.keyPath,t));var u={source:r.source||null,table:n.name,key:void 0===t?null:t,type:s,obj:i},l=e._changes.add(u).then((function(e){return r._lastWrittenRevision=Math.max(r._lastWrittenRevision,e),e}));return this.onsuccess=function(n){t!=n&&l._then((function(){u.key=n,e._changes.put(u)}))},this.onerror=function(){l._then((function(n){e._changes.delete(n)}))},c}}(e,n)),n.hook("updating").subscribe(function(e,n){return function(t,i,r,a){var s={},u=!1,l=o.a.deepClone(r);for(var d in t){var f=t[d];if("undefined"===typeof f)o.a.delByKeyPath(l,d),s[d]=null,u=!0;else{var m=o.a.getByKeyPath(r,d);f!==m&&JSON.stringify(f)!==JSON.stringify(m)&&(o.a.setByKeyPath(l,d,f),s[d]=f,u=!0)}}if(u){var v={source:a.source||null,table:n,key:i,type:c,mods:s,oldObj:r,obj:l},y=e._changes.add(v);this.onsuccess=function(){y._then((function(e){a._lastWrittenRevision=Math.max(a._lastWrittenRevision,e)}))},this.onerror=function(){y._then((function(n){e._changes.delete(n)}))}}}}(e,t)),n.hook("deleting").subscribe(function(e,n){return function(t,o,i){var r=e._changes.add({source:i.source||null,table:n,key:t,type:u,oldObj:o}).then((function(e){return i._lastWrittenRevision=Math.max(i._lastWrittenRevision,e),e})).catch((function(e){console.log(o),console.log(e.stack)}));this.onerror=function(){r._then((function(n){e._changes.delete(n)}))}}}(e,t))}}}var d=o.a.Promise;function f(e,n,t,i,r){var a={};function s(){return i.node?o.a.ignoreTransaction((function(){return e.transaction("rw","_intercomm",(function(){return e._intercomm.where({destinationNode:i.node.id}).toArray((function(n){return n.forEach((function(n){return function(n){if("response"===n.type){var t=a[n.requestId.toString()];t&&(n.isFailure?t.reject(n.message.error):t.resolve(n.message.result),delete a[n.requestId.toString()])}else n.resolve=function(t){e.observable.sendMessage("response",{result:t},n.sender,{requestId:n.id})},n.reject=function(t){e.observable.sendMessage("response",{error:t.toString()},n.sender,{isFailure:!0,requestId:n.id})},e.on.message.fire(n)}(n)})),e._intercomm.where("id").anyOf(n.map((function(e){return e.id}))).delete()}))}))})):d.reject(new o.a.DatabaseClosedError)}return e.observable.sendMessage=function(t,s,c,u){if(u=u||{},!i.node)return u.wantReply?d.reject(new o.a.DatabaseClosedError):d.resolve();var l={message:s,destinationNode:c,sender:i.node.id,type:t};return o.a.extend(l,u),o.a.ignoreTransaction((function(){var t=["_intercomm"];u.wantReply&&t.push("_syncNodes");var o=e.transaction("rw",t,(function(){return u.wantReply?e._syncNodes.where("id").equals(c).count((function(n){return n?e._intercomm.add(l):e._syncNodes.where("isMaster").above(0).first((function(n){return l.destinationNode=n.id,e._intercomm.add(l)}))})):e._intercomm.add(l)})).then((function(t){var o=null;return u.wantReply&&(o=new d((function(e,n){a[t.toString()]={resolve:e,reject:n}}))),r&&r.setItem("Dexie.Observable/intercomm/"+e.name,t.toString()),n.on.intercomm.fire(e.name),o}));return u.wantReply?o:void o.catch((function(){}))}))},e.observable.broadcastMessage=function(n,t,r){if(i.node){var a=i.node.id;o.a.ignoreTransaction((function(){e._syncNodes.toArray((function(o){return d.all(o.filter((function(e){return"local"===e.type&&(r||e.id!==a)})).map((function(o){return e.observable.sendMessage(n,t,o.id)})))})).catch((function(){}))}))}},{onIntercomm:function(n){n===e.name&&s().catch("DatabaseClosedError",(function(){}))},consumeIntercommMessages:s}}function m(e){return function(n,t){n._changes="++rev",n._syncNodes="++id,myRevision,lastHeartBeat,&url,isMaster,type,status",n._intercomm="++id,destinationNode",n._uncommittedChanges="++id,node",e.call(this,n,t),Object.keys(t).forEach((function(e){var n=t[e];0===n.primKey.name.indexOf("$$")&&(n.primKey.uuid=!0,n.primKey.name=n.primKey.name.substr(2),n.primKey.keyPath=n.primKey.keyPath.substr(2))})),Object.keys(t).forEach((function(e){0!==e.indexOf("_")&&0!==e.indexOf("$")&&(t[e].observable=!0)}))}}var v,y=self,p=o.a.defineClass({rev:Number,source:String,table:String,key:Object,type:Number,obj:Object,mods:Object,oldObj:Object}),h=o.a.override,b=o.a.Promise,g=!1;function _(e){var n=2e4,t=2e4,a=500,s=n-5e3,c=_.localStorageImpl,u=o.a.defineClass({myRevision:Number,type:String,lastHeartBeat:Number,deleteTimeStamp:Number,url:String,isMaster:Number,syncProtocol:String,syncContext:null,syncOptions:Object,connected:!1,status:Number,appliedRemoteRevision:null,remoteBaseRevisions:[{local:Number,remote:null}],dbUploadState:{tablesToUpload:[String],currentTable:String,currentKey:null,localBaseRevision:Number}});e.observable={},e.observable.SyncNode=u;var d=function(e,n,t){return function(i){n.latestRevision[e.name]<i&&(n.latestRevision[e.name]=i,o.a.ignoreTransaction((function(){n.on("latestRevisionIncremented").fire(e.name,i)})),t&&t.setItem("Dexie.Observable/latestRevision/"+e.name,i))}}(e,_,c),v=function(e,n){return function(t){return function(o,i,r,a){if(e.dynamicallyOpened())return t.apply(this,arguments);var s=!1;"readwrite"===o&&i.some((function(e){return r[e]&&r[e].observable}))&&(s=!0,-1===(i=i.slice(0)).indexOf("_changes")&&i.push("_changes"));var c=t.call(this,o,i,r,a);return s&&(c._lastWrittenRevision=0,c.on("complete",(function(){if(c._lastWrittenRevision)if(a){var e=function e(n){return n.parent?e(n.parent):n}(a);e._lastWrittenRevision=Math.max(c._lastWrittenRevision,e.lastWrittenRevision||0)}else n.timeoutHandle&&clearTimeout(n.timeoutHandle),n.timeoutHandle=setTimeout((function(){delete n.timeoutHandle,n(c._lastWrittenRevision)}),25)})),c.parent&&c.parent.source&&(c.source=c.parent.source)),c}}}(e,d),w=l(e),R=function(e,n,t){return function(o){return function(){return Object.keys(e._allTables).forEach((function(o){var i=e._allTables[o];i.schema.observable&&t(i),"_syncNodes"===i.name&&i.mapToClass(n)})),o.apply(this,arguments)}}}(e,u,w),x={node:null},N=f(e,_,0,x,c),O=N.onIntercomm,S=N.consumeIntercommMessages;Object.defineProperty(e,"_localSyncNode",{get:function(){return x.node}});var T=null,D=null;o.a.fake&&(e.version(1).stores({_syncNodes:"++id,myRevision,lastHeartBeat",_changes:"++rev",_intercomm:"++id,destinationNode",_uncommittedChanges:"++id,node"}),e._syncNodes.mapToClass(u),e._changes.mapToClass(p),x.node=new u({myRevision:0,type:"local",lastHeartBeat:Date.now(),deleteTimeStamp:null})),e.Version.prototype._parseStoresSpec=h(e.Version.prototype._parseStoresSpec,m),e.on.addEventType({changes:"asap",cleanup:[r,i],message:"asap"}),e._createTransaction=h(e._createTransaction,v),_.latestRevision[e.name]=_.latestRevision[e.name]||0,e.open=h(e.open,R),e.close=h(e.close,(function(n){return function(){return e.dynamicallyOpened()?n.apply(this,arguments):(d.timeoutHandle&&(clearTimeout(d.timeoutHandle),delete d.timeoutHandle),_.on("latestRevisionIncremented").unsubscribe(C),_.on("suicideNurseCall").unsubscribe(H),_.on("intercomm").unsubscribe(O),_.on("beforeunload").unsubscribe(E),x.node&&x.node.id&&(_.on.suicideNurseCall.fire(e.name,x.node.id),c&&c.setItem("Dexie.Observable/deadnode:"+x.node.id.toString()+"/"+e.name,"dead"),x.node.deleteTimeStamp=1,x.node.lastHeartBeat=0,e._syncNodes.put(x.node),x.node=null),T&&clearTimeout(T),T=null,D&&clearTimeout(D),D=null,n.apply(this,arguments))}})),e.delete=h(e.delete,(function(n){return function(){return n.apply(this,arguments).then((function(n){return _.latestRevision[e.name]=0,n}))}})),e.on("ready",(function(){return e.dynamicallyOpened()?e:e.table("_changes").orderBy("rev").last((function(t){var i=t?t.rev:0;return x.node=new u({myRevision:i,type:"local",lastHeartBeat:Date.now(),deleteTimeStamp:null,isMaster:0}),_.latestRevision[e.name]<i&&(_.latestRevision[e.name]=i,o.a.ignoreTransaction((function(){_.on.latestRevisionIncremented.fire(i)}))),e.transaction("rw","_syncNodes",(function(){return e._syncNodes.where("isMaster").equals(1).first((function(t){if(t){if(t.lastHeartBeat<Date.now()-n)return x.node.isMaster=1,t.isMaster=0,e._syncNodes.put(t)}else x.node.isMaster=1})).then((function(){return e._syncNodes.add(x.node).then((function(){_.on("latestRevisionIncremented",C),_.on("beforeunload",E),_.on("suicideNurseCall",H),_.on("intercomm",O),T=setTimeout(B,a),D=setTimeout(M,s)}))}))})).then((function(){j()}))}))}),!0);var k=0;function C(n,t){if(n===e.name){if(k>=t)return;k=t,o.a.vip((function(){I(t).catch("DatabaseClosedError",(function(){}))}))}}function I(n,t,i){if(!t&&I.ongoingOperation)return I.ongoingOperation;var r=!1,a=x.node;if(!a)return b.reject(new o.a.DatabaseClosedError);var s=e._changes.where("rev").above(a.myRevision).limit(1e3).toArray((function(n){if(n.length>0){var t=n[n.length-1];r=1e3===n.length,e.on("changes").fire(n,r),a.myRevision=t.rev}else i&&e.on("changes").fire([],!1);var o=!1;return e._syncNodes.where(":id").equals(a.id).modify((function(e){o=!0,e.lastHeartBeat=Date.now(),e.deleteTimeStamp=null,e.myRevision=Math.max(e.myRevision,a.myRevision)})).then((function(){return o}))})).then((function(n){if(!n)throw g?new Error("Browser is shutting down"):(e.close(),console.error("Out of sync"),y.location&&y.location.reload(!0),new Error("Out of sync"));if(r||_.latestRevision[e.name]>a.myRevision)return I(_.latestRevision[e.name],(t||0)+1,r)})).finally((function(){delete I.ongoingOperation}));return t||(I.ongoingOperation=s),s}function M(){D=null;var n=x.node&&x.node.id;n&&e.transaction("rw!",e._syncNodes,(function(){e._syncNodes.where({id:n}).first((function(n){if(n)return n.lastHeartBeat=Date.now(),n.deleteTimeStamp=null,e._syncNodes.put(n);e.isOpen()&&e.close()}))})).catch("DatabaseClosedError",(function(){})).finally((function(){x.node&&x.node.id===n&&e.isOpen()&&(D=setTimeout(M,s))}))}function B(){T=null;var n=x.node&&x.node.id;n&&o.a.vip((function(){I(_.latestRevision[e.name]).then(j).then(S).catch("DatabaseClosedError",(function(){})).finally((function(){x.node&&x.node.id===n&&e.isOpen()&&(T=setTimeout(B,a))}))}))}function j(){var i=x.node;return i?e.transaction("rw","_syncNodes","_changes","_intercomm",(function(){var o=!1;e._syncNodes.where("lastHeartBeat").below(Date.now()-n).filter((function(e){return"local"===e.type})).modify((function(n){n.deleteTimeStamp&&n.deleteTimeStamp<Date.now()?(delete this.value,c&&c.removeItem("Dexie.Observable/deadnode:"+n.id+"/"+e.name),n.isMaster&&(e._syncNodes.update(i,{isMaster:1}),o=!0),e._intercomm.where({destinationNode:n.id}).modify((function(e){e.wantReply?e.destinationNode=i.id:delete this.value}))):n.deleteTimeStamp||(n.deleteTimeStamp=Date.now()+t)})).then((function(){return _.deleteOldChanges(e),e.on("cleanup").fire(o)}))})):b.reject(new o.a.DatabaseClosedError)}function E(){x.node&&(g=!0,x.node.deleteTimeStamp=1,x.node.lastHeartBeat=0,e._syncNodes.put(x.node),_.wereTheOneDying=!0,c&&c.setItem("Dexie.Observable/deadnode:"+x.node.id.toString()+"/"+e.name,"dead"))}function H(n,t){n!==e.name||_.wereTheOneDying||o.a.vip((function(){e._syncNodes.update(t,{deleteTimeStamp:1,lastHeartBeat:0}).then(j)}))}}_.latestRevision={},_.on=o.a.Events(null,"latestRevisionIncremented","suicideNurseCall","intercomm","beforeunload"),_.createUUID=a,_.deleteOldChanges=function e(n){o.a.ignoreTransaction((function(){return n._syncNodes.orderBy("myRevision").first((function(e){return n._changes.where("rev").below(e.myRevision).limit(100).primaryKeys()})).then((function(t){if(0!==t.length)return n._changes.bulkDelete(t).then((function(){100===t.length&&setTimeout((function(){return n.isOpen()&&e(n)}),500)}))}))})).catch((function(){}))},_._onStorage=(v=_,function(e){if(e.key&&0===e.key.indexOf("Dexie.Observable/")){var n=e.key.split("/"),t=n[1],i=n[2];if("latestRevision"===t){var r=parseInt(e.newValue,10);!isNaN(r)&&r>v.latestRevision[i]&&(v.latestRevision[i]=r,o.a.ignoreTransaction((function(){v.on("latestRevisionIncremented").fire(i,r)})))}else if(0===t.indexOf("deadnode:")){var a=parseInt(t.split(":")[1],10);e.newValue&&v.on.suicideNurseCall.fire(i,a)}else"intercomm"===t&&e.newValue&&v.on.intercomm.fire(i)}}),_._onBeforeUnload=function(){_.on.beforeunload.fire()};try{_.localStorageImpl=y.localStorage}catch(w){}y.addEventListener&&(y.addEventListener("storage",_._onStorage),y.addEventListener("beforeunload",_._onBeforeUnload)),o.a.Observable=_,o.a.addons.push(_);n.default=o.a}}]);